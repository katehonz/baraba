# VAT/DDS Модул - Техническа Документация

## Общ Преглед

VAT/DDS модулът е сложно счетоводно приложение за генериране на ДДС декларации съгласно българското законодателство. Модулът имплементира пълния цикъл на ДДС отчетността - от събиране на данни до генериране на официалните файлове за НАП.

## Архитектура на Модула

### Backend Компоненти (Nim)

#### 1. VAT Controller (`src/controllers/vat_controller.nim`)
**Отговорности**: Бизнес логика и обработка на данни
- `VatTotals`: Обект за акумулиране на суми по всички ДДС колони
- `VatManager`: Главен клас за управление на процеса
- Генериране на три файла: POKUPKI.TXT, PRODAGBI.TXT, DEKLAR.TXT

**Ключови типове**:
```nim
type
  VatTotals* = object
    # Колони 9-15 (покупки)
    col09*: float  # Доставки без право на ДК
    col10*: float  # Облагаеми доставки с право на пълен ДК (данъчна основа)
    col10vat*: float  # ДДС за кол. 10
    # ... останалите колони
```

#### 2. VAT Routes (`src/routes/vat_routes.nim`)
**Отговорности**: REST API крайни точки
- `POST /api/v1/v1/generate/@period`: Генериране на файлове за даден период
- Използва middleware за автентикация и извличане на фирма

#### 3. VAT Rate Model (`src/models/vatrate.nim`)
**Отговорности**: Управление на ДДС ставки
- Динамични ДДС ставки по компании
- Валидност на ставките във времето
- Поддръжка на множествени ставки (20%, 9%, 0%)

### Frontend Компоненти (React/TypeScript)

#### 1. VAT Files Page (`frontend/src/pages/vat/VATFilesPage.tsx`)
**Отговорности**: Потребителски интерфейс за генериране и изтегляне
- Избор на период (година/месец)
- Генериране на файлове с лайв индикация
- Преглед на съдържанието преди изтегляне
- Поддръжка на Windows-1251 кодиране

**Ключови функционалности**:
- Реално време генериране със спинър
- Предварителен преглед на файловете
- Индивидуално и масово изтегляне
- Инструкции за подаване към НАП

#### 2. VAT API Client (`frontend/src/api/vat.ts`)
**Отговорности**: HTTP комуникация с backend
- Base64 кодиране/декодиране
- Преобразуване между Windows-1251 и UTF-8
- Двупосочна поддръжка (display + download)

## Формати на Файловете

### POKUPKI.TXT (Дневник на покупките)
**Фиксирана ширина на полетата:**
```
Позиция | Дължина | Описание
1-15    | 15     | ДДС номер на фирма (BG + ЕИК)
16-21   | 6      | Период (YYYYMM)
22-24   | 3      | Интервали (винаги "   ")
25      | 1      | Тип (винаги "0")
26-39   | 14     | Пореден номер (десностранно подравнен)
40-59   | 20     | Номер на документ
60-69   | 10     | Дата на документ (DD/MM/YYYY)
70-84   | 15     | ДДС номер на контрагент
85-134  | 50     | Име на контрагент
135-174 | 40     | Град на контрагент
175-189 | 15     | Колона 09 (Доставки без право на ДК)
190-204 | 15     | Колона 10 (Облагаеми доставки)
205-219 | 15     | Колона 10 ДДС
220-234 | 15     | Колона 12 (Частичен ДК)
235-249 | 15     | Колона 12 ДДС
250-264 | 15     | Колона 14 (Годишна корекция)
265-279 | 15     | Колона 15 (Тристранни операции)
280-281 | 2      | Разделител (винаги "  ")
```

**Кодиране:** Windows-1251 (CP1251) за съвместимост с НАП системи

### PRODAGBI.TXT (Дневник на продажбите)
**Разширена структура с 17 колони за суми:**
```
... [същите полета като POKUPKI до поз. 174] ...
175-189 | 15     | Колона 11 (Облагаеми 20% - основа)
190-204 | 15     | Колона 11 ДДС
205-219 | 15     | Колона 11 повторение (общо)
220-234 | 15     | Колона 11 ДДС повторение
235-249 | 15     | Колона 12
250-264 | 15     | Колона 13 (ВОП)
265-279 | 15     | Колона 14
280-294 | 15     | Колона 16
295-309 | 15     | Колона 17 (Облагаеми 9% - основа)
310-324 | 15     | Колона 17 ДДС
325-339 | 15     | Колона 19 (Ставка 0%)
340-354 | 15     | Колона 20 (ВОД)
355-369 | 15     | Колона 21 (чл.140, 146, 173)
370-384 | 15     | Колона 22 (услуги чл.21, ал.2)
385-399 | 15     | Колона 23 (чл.69, ал.2)
400-414 | 15     | Колона 24 (Освободени доставки)
415-429 | 15     | Колона 25 (Тристранни)
430-431 | 2      | Разделител
```

### DEKLAR.TXT (Справка-декларация)
**Единствен ред с обобщена информация:**
```
Позиция | Описание
1-15    | ДДС номер на фирма
16-65   | Име на фирма
66-75   | ЕГН на представител
76-125  | Име на представител
126-140 | Брой продажби
141-155 | Брой покупки
156-170 | Облагаеми доставки (общо)
171-185 | ДДС за внасяне
...     | Детайлни суми по всички колони
...     | Крайна сума ДДС за внасяне/възстановяване
```

## Картиране на ДДС Колони

### Покупки (Дневник на покупките)

| Операция | Колона | Описание | Изчисление |
|----------|--------|----------|------------|
| 1-09-1, 1-09-2 | 9 | Доставки без право на данъчен кредит | `total_amount` |
| 1-10-1 до 1-10-6 | 10 | Облагаеми доставки с пълен ДК | `total_amount` + `total_vat_amount` |
| 1-12-1 до 1-12-4 | 12 | Облагаеми доставки с частичен ДК | `total_amount` + `total_vat_amount` |
| 1-14 | 14 | Годишна корекция | `total_amount` |
| 1-15 | 15 | Тристранни операции | `total_amount` |

### Продажби (Дневник на продажбите)

| Операция | Колона | Описание | ДДС ставка |
|----------|--------|----------|------------|
| 2-11, 2-11-1, 2-11-2 | 11 | Стандартна ставка | 20% |
| 2-17, 2-17-old | 17 | Намалена ставка | 9% |
| 2-19-1, 2-19-2 | 19 | Нула процента | 0% |
| 2-20 | 20 | ВОД (вътрешнообщностни доставки) | 0% |
| 2-21-1, 2-21-2 | 21 | чл.140, 146, 173 | Специален режим |
| 2-22 | 22 | услуги чл.21, ал.2 | Специален режим |
| 2-23 | 23 | чл.69, ал.2 | Специален режим |
| 2-24-1 до 2-24-3 | 24 | Освободени доставки | 0% |
| 2-25 | 25 | Тристранни (посредник) | 0% |

## Бизнес Логика и Изчисления

### ДДС Изчисления

```nim
# Облагаеми продажби (основа)
let totalSalesBase = totals.col11 + totals.col17 + totals.col19 + 
                   totals.col20 + totals.col21 + totals.col22 + 
                   totals.col23 + totals.col25

# ДДС за продажби
let totalSalesVat = totals.col11vat + totals.col17vat

# ДДС за покупки (входен данък)
let totalPurchaseVat = totals.col10vat + totals.col12vat

# ДДС за внасяне/възстановяване
let vatDue = totalSalesVat - totalPurchaseVat
```

### Валидация на ДДС номера

```nim
proc getVatNumber(company: Company): string =
  if company.vat_number.startsWith("BG"):
    return company.vat_number
  else:
    return "BG" & company.eik
```

### Форматиране на Суми

```nim
proc formatAmount(f: float, width: int = 15): string =
  let formatted = formatFloat(abs(f), ffDecimal, 2)
  if f < 0:
    return ("-" & formatted).align(width)
  else:
    return formatted.align(width)
```

## API Спецификация

### Крайна Точка: Генериране на ДДС файлове

**URL:** `POST /api/v1/vat/generate/{period}`

**Path Parameters:**
- `period` (string): Период във формат `YYYYMM`

**Request:**
```json
{
  "companyId": 12345
}
```

**Response:**
```json
{
  "POKUPKI.TXT": "base64-encoded-content",
  "PRODAGBI.TXT": "base64-encoded-content", 
  "DEKLAR.TXT": "base64-encoded-content"
}
```

**Status Codes:**
- `200 OK`: Успешно генериране
- `400 Bad Request`: Невалиден период
- `401 Unauthorized`: Изтекъл/невалиден JWT токен
- `404 Not Found`: Фирмата не е намерена
- `500 Internal Server Error`: Грешка при обработка

## Даннъчна Модел

### JournalEntry (Счетоводни записи)
```nim
type JournalEntry* = object of Model
  document_number*: string
  document_date*: DateTime
  total_amount*: float
  total_vat_amount*: float
  vat_purchase_operation*: string
  vat_sales_operation*: string
  counterpart_id*: Option[int64]
  company_id*: int64
  created_at*: DateTime
  updated_at*: DateTime
```

### Counterpart (Контрагенти)
```nim
type Counterpart* = object of Model
  name*: string
  vat_number*: string
  eik*: string
  country*: string
  city*: string
  company_id*: int64
  created_at*: DateTime
  updated_at*: DateTime
```

### VatRate (ДДС ставки)
```nim
type VatRate* = object of Model
  code*: string          # Код на операция
  name*: string          # Описание
  rate*: float           # ДДС % (0.20, 0.09, 0.00)
  vat_direction*: string # PURCHASE/SALES
  is_active*: bool       # Активна ли е ставката
  valid_from*: Option[DateTime]
  valid_to*: Option[DateTime]
  company_id*: int64
```

## Мулти-трейдинг Архитектура

### Thread-Safe операции
```nim
proc generateVatFiles*(company: Company, period: string): tuple[...] =
  # Използване на connection pool за thread safety
  let db = getDbConn()
  defer: releaseDbConn(db)
  
  # Извличане на данни с параметризирани заявки
  let allEntries = findWhere(JournalEntry, db, 
    "company_id = $1 AND document_date >= $2 AND document_date <= $3", 
    $company.id, startDateStr, endDateStr)
```

### Оптимизация на производителността
- Index-и на `company_id` и `document_date`
- Пакетно обработване на записи
- Кеширане на репрезентативна информация
- Минимизиране на DB конекции

## Сигурност

### Аутентикация и Авторизация
- JWT токени с 24-часова валидност
- Middleware валидация на всички крайни точки
- Изолиране на данните по компании

### Защита на данни
- Windows-1251 кодиране за НАП съвместимост
- Base64 енкодинг за транспорт
- Валидация на входни данни
- SQL injection защита чрез параметризирани заявки

## Тестване

### Unit Тестове (Nim)
```nim
suite "VAT Calculation":
  test "column mapping operations":
    check(mapPurchaseColumn("1-10-1") == 10)
    check(mapSalesColumn("2-11") == 11)
  
  test "VAT number formatting":
    let company = newCompany("Test", eik="123456789")
    check(getVatNumber(company) == "BG123456789")
```

### Integration Тестове
- Тестване на крайни точки с реални данни
- Валидация на генерирани файлове
- Performance тестване при голям обем данни

## Deployment

### Environment Configuration
```nim
const
  JwtSecret* = "your-secret-key-min-32-chars"
  JwtExpirationHours* = 24
  DbHost* = "localhost"
  DbName* = "jesterac"
```

### Production Checklist
- [ ] Промяна на JWT secret
- [ ] Настройка на HTTPS
- [ ] Конфигуриране на CORS за production домейни
- [ ] Backup strategy за данни
- [ ] Monitoring и logging

## Международизация

### Поддържани езици
- Български (основен)
- Интерфейс на английски за администриране

### Локализирани компоненти
- Месечни имена (frontend)
- Български текстове в НАП файлове
- Градове и държави на кирилица

## Troubleleshooting

### Често срещани проблеми

**Проблем:** Невалидно кодиране на файлове
**Решение:** Уверете се, че се използва Windows-1251, не UTF-8

**Проблем:** Грешни суми в декларацията
**Решение:** Проверете мапинга на операции и ДДС ставки

**Проблем:** Липсващи записи в дневниците
**Решение:** Валидирайте `vat_purchase_operation` и `vat_sales_operation` полета

**Проблем:** Не се генерират файлове
**Решение:** Проверете JWT токен и company_id в middleware

### Debug техники
- Логване на SQL заявки
- Преглед на генерираните файлове преди submit
- Валидация на дати и периоди
- Тестване с демонстрационни данни

## Будещи Развития

### Планирани подобрения
- Възможност за корекции на предходни периоди
- Автоматично разпознаване на ДДС операции
- Интеграция с банкови извлечения
- Експорт в други формати (XML, Excel)

### Технически дългове
- Премахване на hardcoding-и в мапинг логиката
- Добавяне на конфигурационни файлове за ДДС правила
- Оптимизация на query-тата за големи обеми данни

---

**Бележка:** Тази документация покрива текущата имплементация към версия 1.0. Модулът е проектиран за разширяемост и съответствие с българското ДДС законодателство.