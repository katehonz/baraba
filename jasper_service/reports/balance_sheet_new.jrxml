<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="balance_sheet"
              pageWidth="595"
              pageHeight="842"
              columnWidth="555"
              leftMargin="20"
              rightMargin="20"
              topMargin="20"
              bottomMargin="20">

    <parameter name="company_id" class="java.lang.String">
        <defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000001"]]></defaultValueExpression>
    </parameter>
    <parameter name="date_to" class="java.sql.Date"/>
    <parameter name="company_name" class="java.lang.String" isForPrompting="false">
        <defaultValueExpression><![CDATA["Company Name]]></defaultValueExpression>
    </parameter>

    <queryString>
        <![CDATA[
        WITH account_balances AS (
            SELECT 
                a.id,
                a.code,
                a.name,
                CASE 
                    WHEN a.code LIKE '1%' OR a.code LIKE '5%' THEN 'Assets'
                    WHEN a.code LIKE '2%' OR a.code LIKE '3%' OR a.code LIKE '4%' THEN 'Liabilities'
                    WHEN a.code LIKE '7%' OR a.code LIKE '6%' THEN 'Equity'
                    ELSE 'Other'
                END as section,
                COALESCE(SUM(CASE WHEN el.debit_account_id = a.id THEN el.debit_amount ELSE 0 END), 0) -
                COALESCE(SUM(CASE WHEN el.credit_account_id = a.id THEN el.credit_amount ELSE 0 END), 0) +
                COALESCE(ob.debit, 0) - COALESCE(ob.credit, 0) as balance
            FROM accounts a
            LEFT JOIN entry_lines el ON a.id = el.debit_account_id OR a.id = el.credit_account_id
            LEFT JOIN journal_entries je ON el.journal_entry_id = je.id
            LEFT JOIN opening_balances ob ON a.id = ob.account_id 
                AND je.company_id = a.company_id 
                AND (CAST($P{date_to} AS DATE) IS NULL OR je.accounting_date <= CAST($P{date_to} AS DATE))
            WHERE a.company_id = CAST($P{company_id} AS UUID)
                AND a.is_active = true
                AND (CAST($P{date_to} AS DATE) IS NULL OR je.accounting_date <= CAST($P{date_to} AS DATE))
            GROUP BY a.id, a.code, a.name, ob.debit, ob.credit
        )
        SELECT section, code, name, 
               CASE WHEN balance > 0 THEN balance ELSE 0 END as debit,
               CASE WHEN balance < 0 THEN ABS(balance) ELSE 0 END as credit
        FROM account_balances
        WHERE balance != 0
        ORDER BY 
            CASE 
                WHEN section = 'Assets' THEN 1
                WHEN section = 'Liabilities' THEN 2
                WHEN section = 'Equity' THEN 3
                ELSE 4
            END,
            section, code
        ]]>
    </queryString>

    <field name="section" class="java.lang.String"/>
    <field name="code" class="java.lang.String"/>
    <field name="name" class="java.lang.String"/>
    <field name="debit" class="java.math.BigDecimal"/>
    <field name="credit" class="java.math.BigDecimal"/>

    <variable name="total_assets_debit" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{section}.equals("Assets") ? $F{debit} : new BigDecimal(0)]]></variableExpression>
    </variable>
    
    <variable name="total_assets_credit" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{section}.equals("Assets") ? $F{credit} : new BigDecimal(0)]]></variableExpression>
    </variable>
    
    <variable name="total_liabilities_debit" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{section}.equals("Liabilities") ? $F{debit} : new BigDecimal(0)]]></variableExpression>
    </variable>
    
    <variable name="total_liabilities_credit" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{section}.equals("Liabilities") ? $F{credit} : new BigDecimal(0)]]></variableExpression>
    </variable>
    
    <variable name="total_equity_debit" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{section}.equals("Equity") ? $F{debit} : new BigDecimal(0)]]></variableExpression>
    </variable>
    
    <variable name="total_equity_credit" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{section}.equals("Equity") ? $F{credit} : new BigDecimal(0)]]></variableExpression>
    </variable>

    <variable name="sum_assets_debit" class="java.math.BigDecimal" calculation="Sum">
        <variableExpression><![CDATA[$V{total_assets_debit}]]></variableExpression>
    </variable>
    
    <variable name="sum_assets_credit" class="java.math.BigDecimal" calculation="Sum">
        <variableExpression><![CDATA[$V{total_assets_credit}]]></variableExpression>
    </variable>
    
    <variable name="sum_liabilities_credit" class="java.math.BigDecimal" calculation="Sum">
        <variableExpression><![CDATA[$V{total_liabilities_credit}]]></variableExpression>
    </variable>
    
    <variable name="sum_equity_credit" class="java.math.BigDecimal" calculation="Sum">
        <variableExpression><![CDATA[$V{total_equity_credit}]]></variableExpression>
    </variable>

    <title>
        <band height="80">
            <staticText>
                <reportElement x="0" y="0" width="555" height="30"/>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="DejaVu Sans" size="18" pdfEncoding="UTF-8" isPdfEmbedded="true" isBold="true"/>
                </textElement>
                <text><![CDATA[Balance Sheet]]></text>
            </staticText>
            <textField>
                <reportElement x="0" y="35" width="555" height="20"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA["Company: " + $P{company_name}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="0" y="55" width="555" height="20"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA["As of: " + ($P{date_to} != null ? $P{date_to} : "Today")]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <columnHeader>
        <band height="25">
            <staticText>
                <reportElement mode="Opaque" x="0" y="0" width="80" height="25" backcolor="#CCCCCC"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[Account]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="80" y="0" width="225" height="25" backcolor="#CCCCCC"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[Description]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="305" y="0" width="125" height="25" backcolor="#CCCCCC"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[Debit]]></text>
            </staticText>
            <staticText>
                <reportElement mode="Opaque" x="430" y="0" width="125" height="25" backcolor="#CCCCCC"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[Credit]]></text>
            </staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="20">
            <textField>
                <reportElement x="0" y="0" width="80" height="20"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA[$F{code}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="80" y="0" width="225" height="20"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement/>
                <textFieldExpression><![CDATA[$F{name}]]></textFieldExpression>
            </textField>
            <textField pattern="#,##0.00">
                <reportElement x="305" y="0" width="125" height="20"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA[$F{debit}]]></textFieldExpression>
            </textField>
            <textField pattern="#,##0.00">
                <reportElement x="430" y="0" width="125" height="20"/>
                <box><pen lineWidth="0.5"/></box>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA[$F{credit}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <summary>
        <band height="140">
            <staticText>
                <reportElement x="80" y="10" width="225" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[TOTAL ASSETS:]]></text>
            </staticText>
            <textField pattern="#,##0.00">
                <reportElement x="305" y="10" width="125" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{sum_assets_debit}]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="80" y="40" width="225" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[TOTAL LIABILITIES:]]></text>
            </staticText>
            <textField pattern="#,##0.00">
                <reportElement x="430" y="40" width="125" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{sum_liabilities_credit}]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="80" y="65" width="225" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <text><![CDATA[TOTAL EQUITY:]]></text>
            </staticText>
            <textField pattern="#,##0.00">
                <reportElement x="430" y="65" width="125" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{sum_equity_credit}]]></textFieldExpression>
            </textField>

            <line>
                <reportElement x="80" y="90" width="475" height="1"/>
            </line>

            <textField pattern="#,##0.00">
                <reportElement x="430" y="95" width="125" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font size="12" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{sum_liabilities_credit}.add($V{sum_equity_credit})]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="80" y="95" width="225" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font size="12" isBold="true"/>
                </textElement>
                <text><![CDATA[TOTAL LIABILITIES + EQUITY:]]></text>
            </staticText>

            <textField pattern="dd.MM.yyyy HH:mm">
                <reportElement x="0" y="120" width="555" height="20"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
            </textField>
        </band>
    </summary>

</jasperReport>