import std/[strutils, tables, unicode]

# UTF-8 Cyrillic to Windows-1251 mapping
const cyrillicToWin1251 = {
  # Bulgarian Cyrillic uppercase (А-Я)
  0x0410: 0xC0, 0x0411: 0xC1, 0x0412: 0xC2, 0x0413: 0xC3,
  0x0414: 0xC4, 0x0415: 0xC5, 0x0416: 0xC6, 0x0417: 0xC7,
  0x0418: 0xC8, 0x0419: 0xC9, 0x041A: 0xCA, 0x041B: 0xCB,
  0x041C: 0xCC, 0x041D: 0xCD, 0x041E: 0xCE, 0x041F: 0xCF,
  0x0420: 0xD0, 0x0421: 0xD1, 0x0422: 0xD2, 0x0423: 0xD3,
  0x0424: 0xD4, 0x0425: 0xD5, 0x0426: 0xD6, 0x0427: 0xD7,
  0x0428: 0xD8, 0x0429: 0xD9, 0x042A: 0xDA, 0x042B: 0xDB,
  0x042C: 0xDC, 0x042D: 0xDD, 0x042E: 0xDE, 0x042F: 0xDF,
  # Bulgarian Cyrillic lowercase (а-я)
  0x0430: 0xE0, 0x0431: 0xE1, 0x0432: 0xE2, 0x0433: 0xE3,
  0x0434: 0xE4, 0x0435: 0xE5, 0x0436: 0xE6, 0x0437: 0xE7,
  0x0438: 0xE8, 0x0439: 0xE9, 0x043A: 0xEA, 0x043B: 0xEB,
  0x043C: 0xEC, 0x043D: 0xED, 0x043E: 0xEE, 0x043F: 0xEF,
  0x0440: 0xF0, 0x0441: 0xF1, 0x0442: 0xF2, 0x0443: 0xF3,
  0x0444: 0xF4, 0x0445: 0xF5, 0x0446: 0xF6, 0x0447: 0xF7,
  0x0448: 0xF8, 0x0449: 0xF9, 0x044A: 0xFA, 0x044B: 0xFB,
  0x044C: 0xFC, 0x044D: 0xFD, 0x044E: 0xFE, 0x044F: 0xFF,
  # Special characters
  0x0401: 0xA8,  # Ё
  0x0451: 0xB8,  # ё
  0x2116: 0xB9,  # №
  0x0490: 0xA5,  # Ґ (Ukrainian)
  0x0491: 0xB4,  # ґ (Ukrainian)
  0x0404: 0xAA,  # Є (Ukrainian)
  0x0454: 0xBA,  # є (Ukrainian)
  0x0406: 0xB2,  # І (Ukrainian/Bulgarian)
  0x0456: 0xB3,  # і (Ukrainian/Bulgarian)
  0x0407: 0xAF,  # Ї (Ukrainian)
  0x0457: 0xBF,  # ї (Ukrainian)
}.toTable

proc toWindows1251*(s: string): string =
  ## Convert UTF-8 string to Windows-1251 encoding for NAP VAT files
  result = ""
  for rune in s.runes:
    let code = rune.int
    if code < 128:
      # ASCII characters pass through unchanged
      result.add(char(code))
    elif cyrillicToWin1251.hasKey(code):
      # Cyrillic characters mapped to Windows-1251
      result.add(char(cyrillicToWin1251[code]))
    else:
      # Unknown characters replaced with '?'
      result.add('?')

proc fromWindows1251*(s: string): string =
  ## Convert Windows-1251 string to UTF-8
  # Reverse mapping
  const win1251ToCyrillic = {
    0xC0: "А", 0xC1: "Б", 0xC2: "В", 0xC3: "Г",
    0xC4: "Д", 0xC5: "Е", 0xC6: "Ж", 0xC7: "З",
    0xC8: "И", 0xC9: "Й", 0xCA: "К", 0xCB: "Л",
    0xCC: "М", 0xCD: "Н", 0xCE: "О", 0xCF: "П",
    0xD0: "Р", 0xD1: "С", 0xD2: "Т", 0xD3: "У",
    0xD4: "Ф", 0xD5: "Х", 0xD6: "Ц", 0xD7: "Ч",
    0xD8: "Ш", 0xD9: "Щ", 0xDA: "Ъ", 0xDB: "Ы",
    0xDC: "Ь", 0xDD: "Э", 0xDE: "Ю", 0xDF: "Я",
    0xE0: "а", 0xE1: "б", 0xE2: "в", 0xE3: "г",
    0xE4: "д", 0xE5: "е", 0xE6: "ж", 0xE7: "з",
    0xE8: "и", 0xE9: "й", 0xEA: "к", 0xEB: "л",
    0xEC: "м", 0xED: "н", 0xEE: "о", 0xEF: "п",
    0xF0: "р", 0xF1: "с", 0xF2: "т", 0xF3: "у",
    0xF4: "ф", 0xF5: "х", 0xF6: "ц", 0xF7: "ч",
    0xF8: "ш", 0xF9: "щ", 0xFA: "ъ", 0xFB: "ы",
    0xFC: "ь", 0xFD: "э", 0xFE: "ю", 0xFF: "я",
    0xA8: "Ё", 0xB8: "ё", 0xB9: "№",
  }.toTable

  result = ""
  for c in s:
    let code = ord(c)
    if code < 128:
      result.add(c)
    elif win1251ToCyrillic.hasKey(code):
      result.add(win1251ToCyrillic[code])
    else:
      result.add('?')
